<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager - TumblysArt</title>
  <!-- Auth0 SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
</head>
<body>
  <div id="app">
    <div id="loading" style="text-align: center; padding: 50px;">
      <h2>Loading CMS...</h2>
      <p>Authenticating with Auth0...</p>
    </div>
  </div>

  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
    // Auth0 configuration - REPLACE WITH YOUR VALUES
    const auth0Config = {
      domain: 'dev-l6u01rzekvsugrem.us.auth0.com',        // Replace with your Auth0 domain
      clientId: 'XdK6jtvdtwMzRoaxWwTUZqtEvjgrV0Vs',             // Replace with your Client ID
      authorizationParams: {
        redirect_uri: window.location.origin + '/admin/'
      }
    };

    let auth0Client;

    // Initialize Auth0
    async function initAuth0() {
      try {
        auth0Client = await window.auth0.createAuth0Client(auth0Config);
        
        // Check if user is returning from Auth0 callback
        if (window.location.search.includes('code=') || window.location.search.includes('error=')) {
          await auth0Client.handleRedirectCallback();
          window.history.replaceState({}, document.title, '/admin/');
        }

        // Check if user is authenticated
        const isAuthenticated = await auth0Client.isAuthenticated();
        
        if (isAuthenticated) {
          const user = await auth0Client.getUser();
          console.log('Authenticated user:', user);
          initCMS();
        } else {
          showLoginButton();
        }
      } catch (error) {
        console.error('Auth0 initialization error:', error);
        showError('Authentication failed. Please try again.');
      }
    }

    // Show login button
    function showLoginButton() {
      document.getElementById('app').innerHTML = `
        <div style="text-align: center; padding: 50px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
          <h1 style="color: #333; margin-bottom: 20px;">TumblysArt CMS</h1>
          <p style="color: #666; margin-bottom: 30px;">Please log in to manage your website content</p>
          <button 
            id="loginBtn" 
            style="background: #6366f1; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer;"
            onmouseover="this.style.background='#4f46e5'" 
            onmouseout="this.style.background='#6366f1'"
          >
            Log In with Auth0
          </button>
        </div>
      `;
      
      document.getElementById('loginBtn').addEventListener('click', () => {
        auth0Client.loginWithRedirect();
      });
    }

    // Show error message
    function showError(message) {
      document.getElementById('app').innerHTML = `
        <div style="text-align: center; padding: 50px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
          <h1 style="color: #dc2626;">Error</h1>
          <p style="color: #666;">${message}</p>
          <button onclick="location.reload()" style="background: #6366f1; color: white; border: none; padding: 12px 24px; border-radius: 6px; margin-top: 20px; cursor: pointer;">
            Try Again
          </button>
        </div>
      `;
    }

    // Initialize Decap CMS
    function initCMS() {
      document.getElementById('app').innerHTML = '';
      
      // Configure Decap CMS with custom auth
      window.CMS_MANUAL_INIT = true;
      
      CMS.init({
        config: {
          backend: {
            name: 'git-gateway',
            branch: 'main'
          },
          // Override the auth with our Auth0 implementation
          auth: {
            name: 'custom',
            login: () => auth0Client.loginWithRedirect(),
            logout: () => {
              auth0Client.logout({ 
                logoutParams: { 
                  returnTo: window.location.origin + '/admin/' 
                }
              });
            },
            status: async () => {
              const isAuthenticated = await auth0Client.isAuthenticated();
              if (isAuthenticated) {
                const user = await auth0Client.getUser();
                return { 
                  login: true, 
                  name: user.name || user.email,
                  email: user.email 
                };
              }
              return { login: false };
            }
          }
        }
      });

      // Add logout button to CMS
      setTimeout(() => {
        const cmsHeader = document.querySelector('[data-slate-editor]')?.closest('div')?.parentElement;
        if (cmsHeader) {
          const logoutBtn = document.createElement('button');
          logoutBtn.innerHTML = 'Logout';
          logoutBtn.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999; background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;';
          logoutBtn.addEventListener('click', () => {
            auth0Client.logout({ 
              logoutParams: { 
                returnTo: window.location.origin + '/admin/' 
              }
            });
          });
          document.body.appendChild(logoutBtn);
        }
      }, 2000);
    }

    // Start the authentication flow
    initAuth0();
  </script>
</body>
</html>